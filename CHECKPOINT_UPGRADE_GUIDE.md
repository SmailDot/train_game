# 检查点系统升级指南

## 🎉 好消息！系统已升级

您的训练系统现在具备**智能检查点保护**功能，可以自动保存最佳模型并在崩溃时智能恢复！

## ⚠️ 问题回顾

之前您遇到的问题：

### 1. 回档无效
```
训练到 5240 次，分数从 5.2 降到 1.96 (下降 62%)
系统检测到崩溃，准备回档...
❌ 结果：回档到 checkpoint_5240.pt（就是崩溃的那个）
继续训练，分数继续下降到 1.38, 1.21...
```

**原因**: 旧系统只会载入"最近的"检查点，而不是"最好的"检查点。

### 2. 最佳模型丢失
您的历史最高分 #4963 (1166分) 文件已被删除或覆盖，无法恢复。

## ✅ 现在的解决方案

### 自动保护机制

系统现在会：

1. **自动保存最佳模型**
   - 每次打破记录时，自动创建/更新 `checkpoint_best.pt`
   - 这个文件**永久保存**您的最高分模型
   - 例如：当前已从 #4810 (907分) 创建

2. **智能崩溃恢复**（三级策略）
   ```
   级别 1: checkpoint_best.pt （最优先）
      ↓
   级别 2: scores.json 中的历史最高分
      ↓
   级别 3: 现存文件中最近的5个
   ```

3. **预期效果**
   ```
   训练到 5240 次，分数崩溃到 1.96
   系统检测到崩溃，准备回档...
   ✅ 回档到 checkpoint_best.pt (#4810, 907分)
   学习率重置为 50%
   继续训练，分数恢复到 800+ 正常水平
   ```

## 📖 使用说明

### 首次运行（重要！）

在开始训练前，先创建最佳检查点：

```bash
python create_best_checkpoint.py
```

**输出示例**:
```
💎 创建最佳检查点 (checkpoint_best.pt)
🏆 现存最佳检查点:
   迭代: #4810
   分数: 907
✅ 成功创建 checkpoint_best.pt
```

### 正常训练

直接运行训练即可，系统会自动处理：

```bash
python run_game.py
```

**系统会自动**:
- 检测性能崩溃（下降 > 40%）
- 回档到最佳检查点
- 重置学习率（降为原来的 50%）
- 继续训练

### 监控日志

留意以下关键信息：

#### 新记录产生
```
💎 更新最佳檢查點: checkpoint_best.pt (迭代 #5280, 分數: 950)
```
看到这个说明您打破了记录！系统已自动保存。

#### 崩溃检测
```
⚠️⚠️⚠️ 檢測到性能崩潰！⚠️⚠️⚠️
📉 當前指標 vs 最佳記錄：
   平均分: 1.96 (最佳: 5.20) ↓ 62.3%
🔄 正在回檔到最佳檢查點...
```

#### 成功回档
```
📂 優先嘗試載入最佳檢查點: checkpoint_best.pt
   ✓ 模型參數已載入
   ✓ 優化器狀態已載入
   ✓ 學習率重置為: 0.000125
✅ 成功從最佳檢查點回檔！(迭代 #4810, 平均分: 5.2)
```

## 🔧 维护工具

### 查看检查点状态

```bash
python checkpoint_manager.py
```

选择选项 1 查看所有检查点的分数。

### 手动回档

如果需要手动回档到特定版本：

```bash
python rollback_tool.py
```

系统会显示历史最佳记录，您可以选择要恢复的版本。

## 📊 文件说明

### 重要文件（不要删除）

- `checkpoint_best.pt` - 您的最佳模型（**永久保存**）
- `scores.json` - 历史分数记录（回档依赖它）
- `checkpoint_XXXX.pt` - 定期检查点（每10次迭代）

### 可以删除的文件

使用 `checkpoint_manager.py` 的清理功能：
- 选择选项 2
- 会删除低分检查点（< 300分）
- 保留最近10个和所有高分文件

## ❓ 常见问题

### Q1: 我需要手动备份最佳模型吗？
**A**: 不需要！系统会自动维护 `checkpoint_best.pt`。但建议定期备份整个 `checkpoints/` 文件夹到其他位置。

### Q2: 如果 checkpoint_best.pt 被删除了怎么办？
**A**: 运行 `python create_best_checkpoint.py`，系统会从现存文件中选择最高分的重新创建。

### Q3: 回档后学习率变了吗？
**A**: 是的，回档时学习率会重置为初始值的 50%，这有助于模型稳定恢复。

### Q4: 为什么有时候看不到"打破记录"的消息？
**A**: 只有在每10次迭代保存检查点时才会检查分数。确保您的游戏分数被正确记录到 `scores.json` 中。

### Q5: 我可以手动修改 checkpoint_best.pt 吗？
**A**: 不建议。如果需要更换最佳检查点，使用 `create_best_checkpoint.py` 或 `rollback_tool.py`。

## 🎯 最佳实践

1. **训练前准备**
   ```bash
   python create_best_checkpoint.py  # 创建初始最佳检查点
   python run_game.py                 # 开始训练
   ```

2. **定期检查**
   - 每天查看一次 `checkpoint_manager.py` 的状态
   - 确认最高分记录是否更新
   - 清理不需要的低分文件

3. **备份策略**
   - 每周备份整个 `checkpoints/` 文件夹
   - 特别是当达到新高分时
   - 保留 `scores.json` 文件

4. **崩溃应对**
   - 系统会自动尝试恢复
   - 如果自动恢复失败，运行 `rollback_tool.py`
   - 必要时使用历史备份

## 📈 预期收益

- ✅ **100% 保护**：最佳模型永不丢失
- ✅ **智能恢复**：崩溃后自动回到高分状态
- ✅ **效率提升**：减少因崩溃导致的训练时间损失
- ✅ **无需干预**：全自动运作，专注训练即可

## 🚀 开始训练

一切就绪！现在您可以放心地进行长时间训练，系统会自动保护您的成果。

```bash
# 1. 初始化（首次或想重建最佳检查点时）
python create_best_checkpoint.py

# 2. 开始训练
python run_game.py

# 3. 享受自动保护！
```

祝训练顺利，早日达到新高分！ 🎉
